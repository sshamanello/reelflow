<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReelFlow Studio</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/static/brand/logo.png">
  <link rel="apple-touch-icon" href="/static/brand/logo.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            background: {
              900: '#0a0a0b',
              800: '#131316',
              700: '#1a1a1f',
              600: '#23232a',
            },
            surface: {
              DEFAULT: '#1a1a1f',
              hover: '#23232a',
              border: '#2a2a35',
            },
            light: {
              background: '#f8fafc',
              surface: '#ffffff',
              border: '#e2e8f0',
              hover: '#f1f5f9',
              text: '#1e293b',
              textSecondary: '#64748b',
              textMuted: '#94a3b8',
            },
            primary: {
              DEFAULT: '#14b8a6',
              50: '#f0fdfa',
              100: '#ccfbf1',
              200: '#99f6e4',
              300: '#5eead4',
              400: '#2dd4bf',
              500: '#14b8a6',
              600: '#0d9488',
              700: '#0f766e',
              800: '#115e59',
              900: '#134e4a',
            },
          },
          fontFamily: {
            sans: ['Inter', 'SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
          },
        },
      },
    }
  </script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: #0a0a0b;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.light {
      background: #f8fafc;
    }

    /* Custom scrollbar - Dark */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #131316;
    }

    ::-webkit-scrollbar-thumb {
      background: #2a2a35;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #3a3a45;
    }

    /* Custom scrollbar - Light */
    body.light ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    body.light ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
    }

    body.light ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .transition-smooth {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .grid-pattern {
      background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    body.light .grid-pattern {
      background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
    }
  </style>
</head>
<body class="bg-background-900 text-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useContext, createContext } = React;

    // ====== TRANSLATIONS ======
    const translations = {
      en: {
        navLibrary: "Content Library",
        navSettings: "Settings",
        privacyPolicy: "Privacy Policy",
        termsOfService: "Terms of Service",

        libraryTitle: "Content Library",
        libraryEmpty: "No videos yet",
        libraryEmptyDesc: "Upload your first video to start publishing to TikTok",
        uploadVideo: "Upload Video",
        publishToTikTok: "Publish to TikTok",
        notPublished: "Not published",

        publishFlowTitle: "Publish to TikTok",
        step1Title: "Creator Info",
        step2Title: "Content Preview",
        step3Title: "Video Details",
        step4Title: "Privacy Settings",
        step5Title: "Interaction Settings",
        step6Title: "Commercial Disclosure",
        step7Title: "Review & Consent",
        step8Title: "Publishing Status",

        canPost: "Can Post",
        cannotPost: "Cannot Post",
        nickname: "Nickname",

        videoPreview: "Video Preview",
        noWatermark: "No Watermark",

        videoTitle: "Title",
        videoTitlePlaceholder: "Enter video title...",
        hashtags: "Hashtags",
        hashtagsPlaceholder: "Enter hashtags (comma separated)...",

        privacyLevel: "Privacy Level",
        privacyPublic: "Public - Everyone can see",
        privacyFriends: "Friends - Only followers can see",
        privacyPrivate: "Only Me - Only you can see",

        allowComments: "Allow Comments",
        allowDuet: "Allow Duet",
        allowStitch: "Allow Stitch",

        brandedContent: "Branded Content",
        brandedContentDesc: "Is this branded content?",
        yourBrand: "Your Brand",
        brandedContentType: "Branded Content Type",
        brandedContentOnlyMe: "Note: 'Only Me' privacy is not allowed for branded content",

        uploadDifferentVideo: "Upload Different Video",
        useThisFrame: "Use This Frame",
        videoThumbnail: "Video Thumbnail",
        selectFrame: "Select a frame",

        consentTitle: "Consent & Agreement",
        consentYourBrand: "By posting, you agree to TikTok's Music Usage Confirmation.",
        consentBranded: "By posting, you agree to TikTok's Branded Content Policy and Music Usage Confirmation.",
        agree: "I agree",

        statusUploading: "Uploading...",
        statusProcessing: "Processing...",
        statusPublished: "Published Successfully!",
        statusFailed: "Publishing Failed",
        tryAgain: "Try Again",
        close: "Close",
        viewOnTikTok: "View on TikTok",

        next: "Next",
        back: "Back",
        publish: "Publish",
        cancel: "Cancel",

        connectTikTok: "Connect TikTok",
        connected: "Connected",
        notConnected: "Not connected",
        disconnect: "Disconnect",
        reconnect: "Reconnect",
      },
      ru: {
        navLibrary: "Библиотека контента",
        navSettings: "Настройки",
        privacyPolicy: "Политика конфиденциальности",
        termsOfService: "Условия использования",

        libraryTitle: "Библиотека контента",
        libraryEmpty: "Пока нет видео",
        libraryEmptyDesc: "Загрузите первое видео, чтобы начать публикацию в TikTok",
        uploadVideo: "Загрузить видео",
        publishToTikTok: "Опубликовать в TikTok",
        notPublished: "Не опубликовано",

        publishFlowTitle: "Публикация в TikTok",
        step1Title: "Информация о создателе",
        step2Title: "Предпросмотр контента",
        step3Title: "Детали видео",
        step4Title: "Настройки приватности",
        step5Title: "Настройки взаимодействия",
        step6Title: "Коммерческий контент",
        step7Title: "Проверка и согласие",
        step8Title: "Статус публикации",

        canPost: "Можно публиковать",
        cannotPost: "Нельзя публиковать",
        nickname: "Никнейм",

        videoPreview: "Предпросмотр видео",
        noWatermark: "Без водяного знака",

        videoTitle: "Название",
        videoTitlePlaceholder: "Введите название видео...",
        hashtags: "Хештеги",
        hashtagsPlaceholder: "Введите хештеги (через запятую)...",

        privacyLevel: "Уровень приватности",
        privacyPublic: "Публичный - Все могут видеть",
        privacyFriends: "Друзья - Только подписчики",
        privacyPrivate: "Только я - Только вы можете видеть",

        allowComments: "Разрешить комментарии",
        allowDuet: "Разрешить Duets",
        allowStitch: "Разрешить Stitch",

        brandedContent: "Брендированный контент",
        brandedContentDesc: "Это брендированный контент?",
        yourBrand: "Ваш бренд",
        brandedContentType: "Тип брендированного контента",
        brandedContentOnlyMe: "Примечание: Приватность 'Только я' недоступна для брендированного контента",

        uploadDifferentVideo: "Загрузить другое видео",
        useThisFrame: "Использовать этот кадр",
        videoThumbnail: "Обложка видео",
        selectFrame: "Выберите кадр",

        consentTitle: "Согласие и соглашение",
        consentYourBrand: "Публикуя, вы соглашаетесь с подтверждением использования музыки TikTok.",
        consentBranded: "Публикуя, вы соглашаетесь с политикой брендированного контента и подтверждением использования музыки TikTok.",
        agree: "Я соглашаюсь",

        statusUploading: "Загрузка...",
        statusProcessing: "Обработка...",
        statusPublished: "Успешно опубликовано!",
        statusFailed: "Публикация не удалась",
        tryAgain: "Попробовать снова",
        close: "Закрыть",
        viewOnTikTok: "Смотреть на TikTok",

        next: "Далее",
        back: "Назад",
        publish: "Опубликовать",
        cancel: "Отмена",

        connectTikTok: "Подключить TikTok",
        connected: "Подключено",
        notConnected: "Не подключено",
        disconnect: "Отключить",
        reconnect: "Переподключить",
      },
    };

    // ====== ICONS ======
    const Icons = {
      Library: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
      ),
      Settings: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      ),
      Sun: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
      ),
      Moon: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      ),
      Check: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
        </svg>
      ),
      TikTok: () => (
        <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
        </svg>
      ),
      Plus: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
        </svg>
      ),
      X: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
      ),
      ChevronRight: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
        </svg>
      ),
      ChevronLeft: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
        </svg>
      ),
      Upload: () => (
        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
      ),
    };

    // ====== CONFIG ======
    const API_BASE = 'https://reelflow-worker.sshamanello.workers.dev';
    const CONFIG = {
      API_BASE: API_BASE,
      REDIRECT_URI: 'https://sshamanello.ru/ReelFlow',
      tiktok: {
        authUrl: 'https://www.tiktok.com/v2/auth/authorize',
        clientKey: 'awz0u4dkl7733fhp',
        scopes: ['user.info.basic', 'video.upload', 'video.publish']
      }
    };

    // ====== CONTEXTS ======
    const TranslationContext = createContext();
    const ThemeContext = createContext();

    // ====== API CLIENT ======
    function getSessionId() {
      return localStorage.getItem('reelflow_sid');
    }

    function saveSessionId(sid) {
      localStorage.setItem('reelflow_sid', sid);
      console.log('[Session] Saved sid:', sid);
    }

    function clearSessionId() {
      localStorage.removeItem('reelflow_sid');
      console.log('[Session] Cleared sid');
    }

    async function apiRequest(endpoint, options = {}) {
      const url = `${CONFIG.API_BASE}${endpoint}`;
      const sid = getSessionId();

      const opts = {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...options.headers,
        },
      };

      if (sid) {
        opts.headers['Authorization'] = `Bearer ${sid}`;
      }

      console.log('[API] Request:', endpoint, 'Sid:', sid?.substring(0, 10) + '...');

      const response = await fetch(url, opts);
      const data = await response.json().catch(() => null);

      if (!response.ok) {
        throw new Error(data?.error || `HTTP ${response.status}`);
      }

      if (data.sid && data.sid !== sid) {
        saveSessionId(data.sid);
      }

      return data;
    }

    // ====== OAUTH HELPERS ======
    function openTikTokAuth() {
      const config = CONFIG.tiktok;
      const state = Math.random().toString(36).substring(7);
      const scopes = config.scopes.join(',');
      const authUrl = `${config.authUrl}?client_key=${config.clientKey}&scope=${encodeURIComponent(scopes)}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&response_type=code&state=${state}`;

      console.log('[OAuth] Auth URL:', authUrl);
      const popup = window.open(authUrl, '_blank', 'width=600,height=700');
      console.log('[OAuth] Popup opened:', popup);

      if (!popup || popup.closed || typeof popup.closed == 'undefined') {
        console.error('[OAuth] Popup was blocked!');
        alert('Please allow popups for this site and try again.');
      }

      return popup;
    }

    async function exchangeTikTokCode(code) {
      return await apiRequest('/api/oauth/exchange', {
        method: 'POST',
        body: JSON.stringify({ platform: 'tiktok', code, redirect_uri: CONFIG.REDIRECT_URI }),
      });
    }

    // ====== UI COMPONENTS ======

    // Helper function to format time
    function formatTime(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Sidebar
    function Sidebar({ currentPage, setCurrentPage, profiles, onConnectAccount }) {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);

      const navItems = [
        { id: 'library', icon: <Icons.Library />, label: t.navLibrary },
        { id: 'settings', icon: <Icons.Settings />, label: t.navSettings },
      ];

      return (
        <div className={`fixed left-0 top-0 h-screen w-64 border-r ${isDark ? 'bg-background-800 border-surface-border' : 'bg-white border-gray-200'} z-50`}>
          {/* Logo */}
          <div className="p-6 border-b border-surface-border">
            <h1 className={`text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>
              ReelFlow Studio
            </h1>
          </div>

          {/* Navigation */}
          <nav className="p-4 space-y-2">
            {navItems.map((item) => (
              <button
                key={item.id}
                onClick={() => setCurrentPage(item.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-smooth ${
                  currentPage === item.id
                    ? 'bg-primary text-white'
                    : isDark
                      ? 'text-gray-400 hover:bg-surface hover:text-gray-100'
                      : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                }`}
              >
                {item.icon}
                <span className="font-medium">{item.label}</span>
              </button>
            ))}
          </nav>

          {/* Profile Section */}
          <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-surface-border">
            {profiles.tiktok ? (
              <div className={`flex items-center gap-3 p-3 rounded-xl ${isDark ? 'bg-background-700' : 'bg-gray-100'}`}>
                <div className="w-10 h-10 rounded-lg bg-black text-white flex items-center justify-center">
                  <Icons.TikTok />
                </div>
                <div className="flex-1 min-w-0">
                  <div className={`text-sm font-medium truncate ${isDark ? 'text-gray-100' : 'text-gray-900'}`}>
                    {profiles.tiktok.display_name}
                  </div>
                  <div className={`text-xs truncate ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                    {profiles.tiktok.handle || 'Connected'}
                  </div>
                </div>
              </div>
            ) : (
              <button
                onClick={onConnectAccount}
                className="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-black text-white font-medium hover:bg-gray-800 transition-smooth"
              >
                <Icons.TikTok />
                <span>{t.connectTikTok}</span>
              </button>
            )}
          </div>
        </div>
      );
    }

    // Header
    function Header() {
      const { lang, setLang } = useContext(TranslationContext);
      const { isDark, toggleTheme } = useContext(ThemeContext);

      return (
        <header className="flex items-center justify-between mb-6">
          <div />
          <div className="flex items-center gap-3">
            {/* Language Toggle */}
            <button
              onClick={() => setLang(lang === 'en' ? 'ru' : 'en')}
              className={`px-3 py-2 rounded-lg text-sm font-medium transition-smooth ${isDark ? 'bg-surface hover:bg-surface-hover text-gray-300' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
            >
              {lang === 'en' ? 'EN' : 'RU'}
            </button>

            {/* Theme Toggle */}
            <button
              onClick={toggleTheme}
              className={`p-2 rounded-lg transition-smooth ${isDark ? 'bg-surface hover:bg-surface-hover text-gray-300' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
            >
              {isDark ? <Icons.Sun /> : <Icons.Moon />}
            </button>
          </div>
        </header>
      );
    }

    // TikTok Publish Flow Modal
    function TikTokPublishFlow({ isOpen, onClose, video, profile }) {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);
      const [currentStep, setCurrentStep] = useState(1);
      const [creatorInfo, setCreatorInfo] = useState(null);
      const [uploadedVideoFile, setUploadedVideoFile] = useState(null);
      const [videoPreviewUrl, setVideoPreviewUrl] = useState(null);
      const [publishData, setPublishData] = useState({
        title: '',
        hashtags: [],
        privacy_level: '',
        comment_disabled: false,
        duet_disabled: false,
        stitch_disabled: false,
        is_branded_content: false,
        brand_content_type: [], // 'YOUR_BRAND', 'BRANDED_CONTENT'
        consent: false,
      });
      const [isPublishing, setIsPublishing] = useState(false);
      const [publishResult, setPublishResult] = useState(null);
      const videoInputRef = React.useRef(null);
      const videoPlayerRef = React.useRef(null);
      const [thumbnailUrl, setThumbnailUrl] = useState(null);
      const [currentTime, setCurrentTime] = useState(0);
      const [duration, setDuration] = useState(0);

      // Reset video state when modal opens or closes
      React.useEffect(() => {
        if (isOpen) {
          setUploadedVideoFile(null);
          setVideoPreviewUrl(null);
          setThumbnailUrl(null);
          setCurrentTime(0);
        }
      }, [isOpen]);

      // Fetch creator info on open
      useEffect(() => {
        if (isOpen && currentStep === 1) {
          fetchCreatorInfo();
        }
      }, [isOpen, currentStep]);

      const fetchCreatorInfo = async () => {
        try {
          const response = await apiRequest('/api/tiktok/creator_info');
          setCreatorInfo(response);
        } catch (error) {
          console.error('Failed to fetch creator info:', error);
        }
      };

      const handleVideoUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('video/')) {
          setUploadedVideoFile(file);
          const url = URL.createObjectURL(file);
          setVideoPreviewUrl(url);
          setThumbnailUrl(null); // Reset thumbnail when new video uploaded
        }
      };

      const captureThumbnail = () => {
        const video = videoPlayerRef.current;
        if (!video) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          setThumbnailUrl(url);
        }, 'image/jpeg', 0.9);
      };

      const canProceed = () => {
        switch (currentStep) {
          case 1:
            return creatorInfo?.can_post;
          case 2:
            return true;
          case 3:
            return true; // Title and hashtags are optional
          case 4:
            return publishData.privacy_level !== '';
          case 5:
            return true;
          case 6:
            if (!publishData.is_branded_content) return true;
            // If branded content, at least one type must be selected
            return publishData.brand_content_type.length > 0 &&
                   !(publishData.brand_content_type.includes('BRANDED_CONTENT') && publishData.privacy_level === 'SELF_ONLY');
          case 7:
            return publishData.consent;
          default:
            return false;
        }
      };

      const handlePublish = async () => {
        setIsPublishing(true);
        try {
          let videoRef = video.ref;
          let thumbnailBase64 = null;

          // Convert thumbnail URL to base64 if selected
          if (thumbnailUrl) {
            const response = await fetch(thumbnailUrl);
            const blob = await response.blob();
            thumbnailBase64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
          }

          // If user uploaded a new video, upload it first
          if (uploadedVideoFile) {
            const formData = new FormData();
            formData.append('file', uploadedVideoFile);

            const sid = getSessionId();
            const headers = {};
            if (sid) {
              headers['Authorization'] = `Bearer ${sid}`;
            }

            const uploadResponse = await fetch(`${CONFIG.API_BASE}/api/tiktok/upload`, {
              method: 'POST',
              headers,
              body: formData,
            });

            if (!uploadResponse.ok) {
              throw new Error('Video upload failed');
            }

            const uploadData = await uploadResponse.json();
            videoRef = uploadData.publish_id;
          }

          const response = await apiRequest('/api/tiktok/publish', {
            method: 'POST',
            body: JSON.stringify({
              video_ref: videoRef,
              ...publishData,
              thumbnail_url: thumbnailBase64,
            }),
          });
          setPublishResult({ success: true, data: response });
          setCurrentStep(8);
        } catch (error) {
          setPublishResult({ success: false, error: error.message });
          setCurrentStep(8);
        } finally {
          setIsPublishing(false);
        }
      };

      const renderStep = () => {
        switch (currentStep) {
          case 1:
            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step1Title}
                </h2>
                {creatorInfo ? (
                  <div className={`p-6 rounded-xl ${isDark ? 'bg-surface' : 'bg-gray-100'}`}>
                    <div className="flex items-center gap-4 mb-4">
                      {creatorInfo.avatar_url && (
                        <img src={creatorInfo.avatar_url} alt="Avatar" className="w-16 h-16 rounded-full" />
                      )}
                      <div>
                        <div className={`text-lg font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>
                          {creatorInfo.nickname}
                        </div>
                        <div className={`flex items-center gap-2 text-sm ${creatorInfo.can_post ? 'text-green-500' : 'text-red-500'}`}>
                          {creatorInfo.can_post ? <Icons.Check /> : <Icons.X />}
                          {creatorInfo.can_post ? t.canPost : t.cannotPost}
                        </div>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className={`text-center py-8 ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
                    Loading...
                  </div>
                )}
              </div>
            );

          case 2:
            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step2Title}
                </h2>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Video Preview */}
                <div className="space-y-4">
                  <div className="flex justify-center">
                    <div className={`rounded-xl overflow-hidden ${isDark ? 'bg-surface' : 'bg-gray-100'} flex items-center justify-center`} style={{ height: '400px', width: '225px' }}>
                      {videoPreviewUrl || video.local_preview_url ? (
                        <video
                          ref={videoPlayerRef}
                          src={videoPreviewUrl || video.local_preview_url}
                          className="h-full w-full object-contain"
                          onTimeUpdate={(e) => setCurrentTime(e.target.currentTime)}
                          onLoadedMetadata={(e) => setDuration(e.target.duration)}
                        />
                      ) : (
                        <div className={`text-center ${isDark ? 'text-gray-500' : 'text-gray-400'}`}>
                          <Icons.Upload />
                          <p className="mt-2">{t.selectFrame}</p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Timeline Slider */}
                  {videoPreviewUrl || video.local_preview_url ? (
                    <div className="space-y-2">
                      <input
                        type="range"
                        min="0"
                        max={duration || 100}
                        step="0.1"
                        value={currentTime}
                        onChange={(e) => {
                          const time = parseFloat(e.target.value);
                          setCurrentTime(time);
                          if (videoPlayerRef.current) {
                            videoPlayerRef.current.currentTime = time;
                          }
                        }}
                        className="w-full h-2 rounded-lg appearance-none cursor-pointer"
                        style={{
                          background: isDark ? '#23232a' : '#e2e8f0',
                          accent: '#14b8a6'
                        }}
                      />
                      <div className={`flex justify-between text-xs ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                        <span>{formatTime(currentTime)}</span>
                        <span>{formatTime(duration)}</span>
                      </div>
                    </div>
                  ) : null}

                  {/* Upload Video Button */}
                  <div className="flex justify-center">
                    <input
                      type="file"
                      accept="video/*"
                      onChange={handleVideoUpload}
                      className="hidden"
                      id="video-no-watermark-upload"
                      ref={videoInputRef}
                    />
                    <button
                      onClick={() => videoInputRef.current?.click()}
                      className="flex items-center gap-2 px-6 py-3 rounded-xl bg-primary text-white font-medium hover:bg-primary-600 transition-smooth"
                    >
                      <Icons.Upload />
                      {videoPreviewUrl ? t.uploadDifferentVideo : t.uploadDifferentVideo}
                    </button>
                  </div>
                </div>

                {/* Thumbnail Preview */}
                <div className="space-y-4">
                  <h3 className={`font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                    {t.videoThumbnail}
                  </h3>

                  <div className="flex justify-center">
                    <div className={`rounded-xl overflow-hidden ${isDark ? 'bg-surface' : 'bg-gray-100'} flex items-center justify-center relative`} style={{ height: '400px', width: '225px' }}>
                      {thumbnailUrl ? (
                        <img
                          src={thumbnailUrl}
                          alt="Thumbnail"
                          className="h-full w-full object-cover"
                        />
                      ) : (
                        <div className={`text-center ${isDark ? 'text-gray-500' : 'text-gray-400'}`}>
                          <Icons.Check />
                          <p className="mt-2 text-sm">
                            {t.selectFrame}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Capture Button */}
                  <div className="flex justify-center">
                    <button
                      onClick={captureThumbnail}
                      disabled={!videoPreviewUrl && !video.local_preview_url}
                      className={`flex items-center gap-2 px-6 py-3 rounded-xl font-medium transition-smooth ${
                        (videoPreviewUrl || video.local_preview_url)
                          ? 'bg-accent text-white hover:bg-accent-600'
                          : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      <Icons.Check />
                      {t.useThisFrame}
                    </button>
                  </div>
                </div>
              </div>
              </div>
            );

          case 3:
            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step3Title}
                </h2>
                <div className="space-y-4">
                  <div>
                    <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                      {t.videoTitle}
                    </label>
                    <input
                      type="text"
                      value={publishData.title}
                      onChange={(e) => setPublishData({ ...publishData, title: e.target.value })}
                      placeholder={t.videoTitlePlaceholder}
                      className={`w-full px-4 py-3 rounded-xl border ${isDark ? 'bg-surface border-surface-border text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'} focus:outline-none focus:ring-2 focus:ring-primary`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                      {t.hashtags}
                    </label>
                    <input
                      type="text"
                      value={publishData.hashtags.join(', ')}
                      onChange={(e) => setPublishData({ ...publishData, hashtags: e.target.value.split(',').map(h => h.trim()).filter(h => h) })}
                      placeholder={t.hashtagsPlaceholder}
                      className={`w-full px-4 py-3 rounded-xl border ${isDark ? 'bg-surface border-surface-border text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'} focus:outline-none focus:ring-2 focus:ring-primary`}
                    />
                  </div>
                </div>
              </div>
            );

          case 4:
            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step4Title}
                </h2>
                <div>
                  <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                    {t.privacyLevel}
                  </label>
                  <select
                    value={publishData.privacy_level}
                    onChange={(e) => setPublishData({ ...publishData, privacy_level: e.target.value })}
                    className={`w-full px-4 py-3 rounded-xl border ${isDark ? 'bg-surface border-surface-border text-white' : 'bg-white border-gray-300 text-gray-900'} focus:outline-none focus:ring-2 focus:ring-primary`}
                  >
                    <option value="">{lang === 'ru' ? 'Выберите уровень приватности' : 'Select privacy level'}</option>
                    <option value="PUBLIC_TO_EVERYONE">{t.privacyPublic}</option>
                    <option value="MUTUAL_FOLLOW_FRIEND">{t.privacyFriends}</option>
                    <option value="SELF_ONLY">{t.privacyPrivate}</option>
                  </select>
                </div>
              </div>
            );

          case 5:
            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step5Title}
                </h2>
                <div className="space-y-4">
                  {[
                    { key: 'comment', label: t.allowComments },
                    { key: 'duet', label: t.allowDuet },
                    { key: 'stitch', label: t.allowStitch },
                  ].map(({ key, label }) => (
                    <label key={key} className={`flex items-center justify-between p-4 rounded-xl cursor-pointer transition-smooth ${isDark ? 'bg-surface hover:bg-surface-hover' : 'bg-gray-100 hover:bg-gray-200'}`}>
                      <span className={`font-medium ${isDark ? 'text-gray-200' : 'text-gray-800'}`}>{label}</span>
                      <input
                        type="checkbox"
                        checked={!publishData[`${key}_disabled`]}
                        onChange={(e) => setPublishData({ ...publishData, [`${key}_disabled`]: !e.target.checked })}
                        className="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary"
                      />
                    </label>
                  ))}
                </div>
              </div>
            );

          case 6:
            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step6Title}
                </h2>
                <div className={`p-4 rounded-xl ${isDark ? 'bg-surface' : 'bg-gray-100'}`}>
                  <label className={`flex items-start gap-3 cursor-pointer`}>
                    <input
                      type="checkbox"
                      checked={publishData.is_branded_content}
                      onChange={(e) => setPublishData({ ...publishData, is_branded_content: e.target.checked, brand_content_type: [] })}
                      className="w-5 h-5 mt-0.5 rounded border-gray-300 text-primary focus:ring-primary"
                    />
                    <div className="flex-1">
                      <div className={`font-medium ${isDark ? 'text-white' : 'text-gray-900'}`}>{t.brandedContent}</div>
                      <div className={`text-sm mt-1 ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>{t.brandedContentDesc}</div>
                    </div>
                  </label>
                </div>

                {publishData.is_branded_content && (
                  <div className="space-y-3">
                    <div className={`text-sm font-medium ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>{t.brandedContentType}</div>
                    {[
                      { value: 'YOUR_BRAND', label: t.yourBrand },
                      { value: 'BRANDED_CONTENT', label: 'Branded Content' },
                    ].map(({ value, label }) => (
                      <label key={value} className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-smooth ${isDark ? 'bg-surface hover:bg-surface-hover' : 'bg-gray-100 hover:bg-gray-200'}`}>
                        <input
                          type="checkbox"
                          checked={publishData.brand_content_type.includes(value)}
                          onChange={(e) => {
                            const newTypes = e.target.checked
                              ? [...publishData.brand_content_type, value]
                              : publishData.brand_content_type.filter(t => t !== value);
                            setPublishData({ ...publishData, brand_content_type: newTypes });
                          }}
                          disabled={value === 'BRANDED_CONTENT' && publishData.privacy_level === 'SELF_ONLY'}
                          className="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary disabled:opacity-50"
                        />
                        <span className={`font-medium ${isDark ? 'text-gray-200' : 'text-gray-800'}`}>{label}</span>
                      </label>
                    ))}
                    {publishData.brand_content_type.includes('BRANDED_CONTENT') && publishData.privacy_level === 'SELF_ONLY' && (
                      <div className="text-sm text-amber-500">{t.brandedContentOnlyMe}</div>
                    )}
                  </div>
                )}
              </div>
            );

          case 7:
            const getConsentText = () => {
              const hasYourBrand = publishData.brand_content_type.includes('YOUR_BRAND');
              const hasBranded = publishData.brand_content_type.includes('BRANDED_CONTENT');

              if (hasYourBrand && hasBranded) return t.consentBranded;
              if (hasBranded) return t.consentBranded;
              if (hasYourBrand) return t.consentYourBrand;
              return t.consentYourBrand;
            };

            return (
              <div className="space-y-6">
                <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {t.step7Title}
                </h2>
                <div className={`p-6 rounded-xl ${isDark ? 'bg-surface' : 'bg-gray-100'}`}>
                  <label className={`flex items-start gap-3 cursor-pointer`}>
                    <input
                      type="checkbox"
                      checked={publishData.consent}
                      onChange={(e) => setPublishData({ ...publishData, consent: e.target.checked })}
                      className="w-5 h-5 mt-0.5 rounded border-gray-300 text-primary focus:ring-primary"
                    />
                    <div className="flex-1">
                      <div className={`text-sm ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>{getConsentText()}</div>
                    </div>
                  </label>
                </div>

                {/* Summary */}
                <div className={`p-6 rounded-xl ${isDark ? 'bg-surface' : 'bg-gray-100'}`}>
                  <h3 className={`font-semibold mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>Summary</h3>
                  <div className="space-y-2 text-sm">
                    <div className={`flex justify-between ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                      <span>Title:</span>
                      <span className={isDark ? 'text-white' : 'text-gray-900'}>{publishData.title || '(empty)'}</span>
                    </div>
                    <div className={`flex justify-between ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                      <span>Privacy:</span>
                      <span className={isDark ? 'text-white' : 'text-gray-900'}>
                        {publishData.privacy_level === 'PUBLIC_TO_EVERYONE' ? 'Public' :
                         publishData.privacy_level === 'MUTUAL_FOLLOW_FRIEND' ? 'Friends' :
                         publishData.privacy_level === 'SELF_ONLY' ? 'Only Me' : '(not set)'}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            );

          case 8:
            return (
              <div className="space-y-6 text-center">
                {isPublishing ? (
                  <>
                    <div className="text-6xl">⏳</div>
                    <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                      {t.statusUploading}
                    </h2>
                  </>
                ) : publishResult?.success ? (
                  <>
                    <div className="text-6xl">✅</div>
                    <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                      {t.statusPublished}
                    </h2>
                    <a
                      href={publishResult.data?.video_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="inline-block px-6 py-3 rounded-xl bg-primary text-white font-medium hover:bg-primary-600 transition-smooth"
                    >
                      {t.viewOnTikTok}
                    </a>
                  </>
                ) : (
                  <>
                    <div className="text-6xl">❌</div>
                    <h2 className={`text-xl font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                      {t.statusFailed}
                    </h2>
                    <div className={`text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
                      {publishResult?.error}
                    </div>
                    <button
                      onClick={() => setCurrentStep(1)}
                      className="px-6 py-3 rounded-xl bg-primary text-white font-medium hover:bg-primary-600 transition-smooth"
                    >
                      {t.tryAgain}
                    </button>
                  </>
                )}
              </div>
            );

          default:
            return null;
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
          <div className={`w-full max-w-2xl rounded-2xl shadow-xl ${isDark ? 'bg-background-800' : 'bg-white'} animate-slide-up`}>
            {/* Header */}
            <div className={`flex items-center justify-between p-6 border-b ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
              <h2 className={`text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {t.publishFlowTitle}
              </h2>
              <button
                onClick={onClose}
                className={`p-2 rounded-lg transition-smooth ${isDark ? 'hover:bg-surface text-gray-400 hover:text-gray-200' : 'hover:bg-gray-100 text-gray-600 hover:text-gray-900'}`}
              >
                <Icons.X />
              </button>
            </div>

            {/* Progress Steps */}
            {currentStep < 8 && (
              <div className={`px-6 py-4 border-b ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
                <div className="flex items-center justify-between">
                  {[1, 2, 3, 4, 5, 6, 7].map((step) => (
                    <React.Fragment key={step}>
                      <div className={`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium ${
                        step === currentStep
                          ? 'bg-primary text-white'
                          : step < currentStep
                            ? 'bg-green-500 text-white'
                            : isDark
                              ? 'bg-surface text-gray-500'
                              : 'bg-gray-200 text-gray-600'
                      }`}>
                        {step < currentStep ? <Icons.Check /> : step}
                      </div>
                      {step < 7 && (
                        <div className={`flex-1 h-0.5 mx-2 ${
                          step < currentStep ? 'bg-green-500' : isDark ? 'bg-surface' : 'bg-gray-200'
                        }`} />
                      )}
                    </React.Fragment>
                  ))}
                </div>
              </div>
            )}

            {/* Content */}
            <div className="p-6">
              {renderStep()}
            </div>

            {/* Footer */}
            {currentStep < 8 && (
              <div className={`flex items-center justify-between p-6 border-t ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
                <button
                  onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
                  disabled={currentStep === 1}
                  className={`px-6 py-3 rounded-xl font-medium transition-smooth ${
                    currentStep === 1
                      ? 'opacity-50 cursor-not-allowed'
                      : isDark
                        ? 'bg-surface hover:bg-surface-hover text-gray-300'
                        : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                  }`}
                >
                  <Icons.ChevronLeft />
                  {t.back}
                </button>

                {currentStep < 7 ? (
                  <button
                    onClick={() => setCurrentStep(currentStep + 1)}
                    disabled={!canProceed()}
                    className={`px-6 py-3 rounded-xl font-medium transition-smooth flex items-center gap-2 ${
                      canProceed()
                        ? 'bg-primary text-white hover:bg-primary-600'
                        : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                    }`}
                  >
                    {t.next}
                    <Icons.ChevronRight />
                  </button>
                ) : (
                  <button
                    onClick={handlePublish}
                    disabled={!canProceed() || isPublishing}
                    className={`px-6 py-3 rounded-xl font-medium transition-smooth ${
                      canProceed() && !isPublishing
                        ? 'bg-primary text-white hover:bg-primary-600'
                        : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                    }`}
                  >
                    {t.publish}
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    // Content Library Page
    function ContentLibraryPage({ onPublish }) {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);
      const [videos, setVideos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showUploadModal, setShowUploadModal] = useState(false);

      useEffect(() => {
        loadVideos();
      }, []);

      const loadVideos = async () => {
        try {
          const response = await apiRequest('/api/videos');
          setVideos(response.videos || []);
        } catch (error) {
          console.error('Failed to load videos:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleUploadSuccess = (newVideo) => {
        setVideos([newVideo, ...videos]);
        setShowUploadModal(false);
      };

      const handlePublishClick = (video) => {
        onPublish(video);
      };

      const handleDelete = async (videoId) => {
        if (!confirm(lang === 'ru' ? 'Удалить это видео?' : 'Delete this video?')) {
          return;
        }

        try {
          await apiRequest(`/api/videos/${videoId}`, {
            method: 'DELETE',
          });
          setVideos(videos.filter(v => v.id !== videoId));
        } catch (error) {
          console.error('Delete error:', error);
          alert('Failed to delete video: ' + error.message);
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-96">
            <div className={`text-lg ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>Loading...</div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {t.libraryTitle}
              </h1>
              <p className={`text-sm mt-1 ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                {videos.length} {videos.length === 1 ? 'video' : 'videos'}
              </p>
            </div>
            <button
              onClick={() => setShowUploadModal(true)}
              className="flex items-center gap-2 px-6 py-3 rounded-xl bg-primary text-white font-medium hover:bg-primary-600 transition-smooth"
            >
              <Icons.Plus />
              {t.uploadVideo}
            </button>
          </div>

          {videos.length === 0 ? (
            <div className={`flex flex-col items-center justify-center h-96 rounded-2xl border-2 border-dashed ${isDark ? 'border-surface-border' : 'border-gray-300'}`}>
              <div className="text-6xl mb-4">📹</div>
              <h3 className={`text-lg font-semibold mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {t.libraryEmpty}
              </h3>
              <p className={`text-sm ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                {t.libraryEmptyDesc}
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {videos.map((video) => (
                <div
                  key={video.id}
                  className={`rounded-2xl border overflow-hidden transition-smooth hover:shadow-lg ${isDark ? 'bg-surface border-surface-border' : 'bg-white border-gray-200'}`}
                >
                  <div className="bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center relative" style={{ height: '300px', width: '100%' }}>
                    {video.local_preview_url ? (
                      <video
                        src={video.local_preview_url}
                        className="absolute inset-0 w-full h-full object-cover"
                        muted
                        onLoadedData={(e) => {
                          e.target.currentTime = 1; // Show frame at 1 second
                        }}
                      />
                    ) : (
                      <div className="text-center p-4">
                        <Icons.Upload />
                        <p className={`text-xs mt-2 ${isDark ? 'text-gray-500' : 'text-gray-400'}`}>
                          No preview
                        </p>
                      </div>
                    )}
                    {/* Delete button */}
                    <button
                      onClick={() => handleDelete(video.id)}
                      className="absolute top-2 right-2 p-2 rounded-lg bg-black/50 hover:bg-black/70 text-white transition-smooth"
                      title={lang === 'ru' ? 'Удалить' : 'Delete'}
                    >
                      <Icons.X />
                    </button>
                  </div>
                  <div className="p-4">
                    <h3 className={`font-semibold mb-2 truncate ${isDark ? 'text-white' : 'text-gray-900'}`}>
                      {video.name}
                    </h3>
                    <div className={`text-sm mb-4 ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                      {video.status === 'published' ? 'Published' : t.notPublished}
                    </div>
                    <button
                      onClick={() => handlePublishClick(video)}
                      className="w-full py-2 rounded-lg bg-primary text-white font-medium hover:bg-primary-600 transition-smooth"
                    >
                      {t.publishToTikTok}
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Upload Modal */}
          {showUploadModal && (
            <UploadModal
              isOpen={showUploadModal}
              onClose={() => setShowUploadModal(false)}
              onUploadSuccess={handleUploadSuccess}
            />
          )}
        </div>
      );
    }

    // Upload Modal
    function UploadModal({ isOpen, onClose, onUploadSuccess }) {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);
      const [file, setFile] = useState(null);
      const [previewUrl, setPreviewUrl] = useState(null);
      const [uploading, setUploading] = useState(false);
      const fileInputRef = React.useRef(null);

      // Reset state when modal closes
      React.useEffect(() => {
        if (!isOpen) {
          setFile(null);
          setPreviewUrl(null);
        }
      }, [isOpen]);

      const handleFileChange = (e) => {
        const selectedFile = e.target.files[0];
        if (selectedFile && selectedFile.type.startsWith('video/')) {
          setFile(selectedFile);
          // Create local preview URL immediately
          const url = URL.createObjectURL(selectedFile);
          setPreviewUrl(url);
        }
      };

      const handleButtonClick = () => {
        fileInputRef.current?.click();
      };

      const handleUpload = async () => {
        if (!file) return;

        setUploading(true);
        try {
          const formData = new FormData();
          formData.append('file', file);

          const sid = getSessionId();
          const headers = {};
          if (sid) {
            headers['Authorization'] = `Bearer ${sid}`;
          }

          const response = await fetch(`${CONFIG.API_BASE}/api/tiktok/upload`, {
            method: 'POST',
            headers,
            body: formData,
          });

          if (!response.ok) {
            throw new Error('Upload failed');
          }

          const data = await response.json();
          onUploadSuccess({
            id: Date.now(),
            name: file.name,
            status: 'uploaded',
            ref: data.publish_id,
            local_preview_url: previewUrl, // Локальный preview URL
          });
        } catch (error) {
          console.error('Upload error:', error);
          alert('Upload failed: ' + error.message);
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
          <div className={`w-full max-w-md rounded-2xl shadow-xl ${isDark ? 'bg-background-800' : 'bg-white'}`}>
            <div className={`flex items-center justify-between p-6 border-b ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
              <h2 className={`text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {t.uploadVideo}
              </h2>
              <button
                onClick={onClose}
                className={`p-2 rounded-lg transition-smooth ${isDark ? 'hover:bg-surface text-gray-400' : 'hover:bg-gray-100 text-gray-600'}`}
              >
                <Icons.X />
              </button>
            </div>

            <div className="p-6 space-y-4">
              {/* Preview */}
              {previewUrl && (
                <div className="flex justify-center">
                  <div className={`rounded-xl overflow-hidden ${isDark ? 'bg-surface' : 'bg-gray-100'}`} style={{ height: '200px', width: '112px' }}>
                    <video
                      src={previewUrl}
                      className="h-full w-full object-contain"
                      muted
                      onLoadedData={(e) => {
                        e.target.currentTime = 1;
                      }}
                    />
                  </div>
                </div>
              )}

              {/* Upload area */}
              <div className={`border-2 border-dashed rounded-xl p-8 text-center ${isDark ? 'border-surface-border' : 'border-gray-300'}`}>
                <input
                  type="file"
                  accept="video/*"
                  onChange={handleFileChange}
                  className="hidden"
                  id="video-upload"
                  ref={fileInputRef}
                />
                <div
                  onClick={handleButtonClick}
                  className="cursor-pointer flex flex-col items-center gap-3"
                >
                  <Icons.Upload />
                  <div className={`text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
                    {file ? file.name : 'Click to select a video file'}
                  </div>
                </div>
              </div>
            </div>

            <div className={`flex gap-3 p-6 border-t ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
              <button
                onClick={onClose}
                className={`flex-1 px-6 py-3 rounded-xl font-medium transition-smooth ${isDark ? 'bg-surface hover:bg-surface-hover text-gray-300' : 'bg-gray-100 hover:bg-gray-200 text-gray-700'}`}
              >
                {t.cancel}
              </button>
              <button
                onClick={handleUpload}
                disabled={!file || uploading}
                className={`flex-1 px-6 py-3 rounded-xl font-medium transition-smooth ${
                  file && !uploading
                    ? 'bg-primary text-white hover:bg-primary-600'
                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                }`}
              >
                {uploading ? 'Uploading...' : t.uploadVideo}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Settings Page
    function SettingsPage({ profiles, onConnectAccount, onLogout }) {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);

      return (
        <div className="space-y-6">
          <h1 className={`text-2xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>
            {t.navSettings}
          </h1>

          <div className={`border rounded-2xl p-6 ${isDark ? 'bg-surface border-surface-border' : 'bg-white border-gray-200'}`}>
            <h2 className={`text-lg font-semibold mb-4 ${isDark ? 'text-white' : 'text-gray-900'}`}>
              Connected Accounts
            </h2>

            <div className={`p-4 rounded-xl ${isDark ? 'bg-background-800' : 'bg-gray-50'}`}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  {profiles.tiktok?.avatar_url ? (
                    <img
                      src={profiles.tiktok.avatar_url}
                      alt={profiles.tiktok.display_name}
                      className="w-12 h-12 rounded-xl object-cover"
                    />
                  ) : (
                    <div className="w-12 h-12 rounded-xl bg-black text-white flex items-center justify-center">
                      <Icons.TikTok />
                    </div>
                  )}
                  <div>
                    {profiles.tiktok ? (
                      <>
                        <div className={`text-base font-medium ${isDark ? 'text-gray-100' : 'text-gray-900'}`}>
                          {profiles.tiktok.display_name}
                        </div>
                        <div className={`text-sm ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                          {profiles.tiktok.followers_count
                            ? `${profiles.tiktok.followers_count?.toLocaleString()} followers`
                            : (profiles.tiktok.handle || t.connected)
                          }
                        </div>
                      </>
                    ) : (
                      <div className={`text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
                        {t.notConnected}
                      </div>
                    )}
                  </div>
                </div>
                <div className="flex gap-2">
                  {profiles.tiktok ? (
                    <>
                      <button
                        onClick={onConnectAccount}
                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-smooth ${isDark ? 'bg-background-700 text-gray-300 hover:bg-background-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                      >
                        {t.reconnect}
                      </button>
                      <button
                        onClick={() => onLogout('tiktok')}
                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-smooth bg-red-100 text-red-700 hover:bg-red-200`}
                      >
                        {t.disconnect}
                      </button>
                    </>
                  ) : (
                    <button
                      onClick={onConnectAccount}
                      className="px-4 py-2 rounded-xl text-sm font-medium transition-smooth bg-black text-white hover:bg-gray-800"
                    >
                      {t.connectTikTok}
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Auth Modal
    function AuthModal({ isOpen, onClose, onSuccess }) {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);
      const [code, setCode] = useState('');
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        if (isOpen) {
          // Listen for OAuth callback
          const handleOAuthCallback = (event) => {
            if (event.data.type === 'oauth_code') {
              handleCodeExchange(event.data.code);
            }
          };
          window.addEventListener('message', handleOAuthCallback);
          return () => window.removeEventListener('message', handleOAuthCallback);
        }
      }, [isOpen]);

      const handleOpenAuth = () => {
        openTikTokAuth();
      };

      const handleCodeExchange = async (authCode) => {
        setLoading(true);
        try {
          const result = await exchangeTikTokCode(authCode);
          if (result.ok) {
            onSuccess(result.profile);
            onClose();
          }
        } catch (error) {
          console.error('Auth error:', error);
          alert('Authentication failed: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const handleManualSubmit = async () => {
        if (!code.trim()) return;
        await handleCodeExchange(code.trim());
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
          <div className={`w-full max-w-md rounded-2xl shadow-xl ${isDark ? 'bg-background-800' : 'bg-white'}`}>
            <div className={`flex items-center justify-between p-6 border-b ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
              <h2 className={`text-xl font-bold ${isDark ? 'text-white' : 'text-gray-900'}`}>
                {t.connectTikTok}
              </h2>
              <button
                onClick={onClose}
                className={`p-2 rounded-lg transition-smooth ${isDark ? 'hover:bg-surface text-gray-400' : 'hover:bg-gray-100 text-gray-600'}`}
              >
                <Icons.X />
              </button>
            </div>

            <div className="p-6 space-y-4">
              <button
                onClick={handleOpenAuth}
                className="w-full flex items-center justify-center gap-3 px-6 py-4 rounded-xl bg-black text-white font-medium hover:bg-gray-800 transition-smooth"
              >
                <Icons.TikTok />
                Connect with TikTok
              </button>

              <div className={`text-center text-sm ${isDark ? 'text-gray-500' : 'text-gray-600'}`}>
                or paste authorization code manually:
              </div>

              <input
                type="text"
                value={code}
                onChange={(e) => setCode(e.target.value)}
                placeholder="Paste authorization code from TikTok..."
                className={`w-full px-4 py-3 rounded-xl border ${isDark ? 'bg-surface border-surface-border text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'} focus:outline-none focus:ring-2 focus:ring-primary`}
              />

              <button
                onClick={handleManualSubmit}
                disabled={!code.trim() || loading}
                className={`w-full px-6 py-3 rounded-xl font-medium transition-smooth ${
                  code.trim() && !loading
                    ? 'bg-primary text-white hover:bg-primary-600'
                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                }`}
              >
                {loading ? 'Connecting...' : 'Connect'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Footer
    function Footer() {
      const { lang, t } = useContext(TranslationContext);
      const { isDark } = useContext(ThemeContext);

      return (
        <footer className={`mt-auto py-6 px-6 border-t ${isDark ? 'border-surface-border' : 'border-gray-200'}`}>
          <div className="flex items-center justify-center gap-6 text-sm">
            <a
              href="/privacy"
              className={`transition-smooth hover:text-primary ${isDark ? 'text-gray-500' : 'text-gray-600'}`}
            >
              {t.privacyPolicy}
            </a>
            <span className={isDark ? 'text-gray-700' : 'text-gray-300'}>|</span>
            <a
              href="/terms"
              className={`transition-smooth hover:text-primary ${isDark ? 'text-gray-500' : 'text-gray-600'}`}
            >
              {t.termsOfService}
            </a>
          </div>
        </footer>
      );
    }

    // Main App
    function App() {
      const [lang, setLang] = useState('en');
      const [isDark, setIsDark] = useState(true);
      const [currentPage, setCurrentPage] = useState('library');
      const [profiles, setProfiles] = useState({});
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [selectedVideo, setSelectedVideo] = useState(null);

      const t = translations[lang];

      const toggleTheme = () => setIsDark(!isDark);

      useEffect(() => {
        loadProfiles();
      }, []);

      // Update body class when theme changes
      useEffect(() => {
        if (isDark) {
          document.body.classList.remove('light');
        } else {
          document.body.classList.add('light');
        }
      }, [isDark]);

      const loadProfiles = async () => {
        try {
          const response = await apiRequest('/api/me');
          setProfiles(response.profiles || {});
        } catch (error) {
          console.error('Failed to load profiles:', error);
        }
      };

      const handleAuthSuccess = (profile) => {
        loadProfiles();
      };

      const handleLogout = async (platform) => {
        try {
          await apiRequest('/api/oauth/logout', {
            method: 'POST',
            body: JSON.stringify({ platform }),
          });
          loadProfiles();
        } catch (error) {
          console.error('Logout error:', error);
        }
      };

      const handlePublish = (video) => {
        if (!profiles.tiktok) {
          setShowAuthModal(true);
          return;
        }
        setSelectedVideo(video);
      };

      return (
        <TranslationContext.Provider value={{ lang, setLang, t, isDark }}>
          <ThemeContext.Provider value={{ isDark, toggleTheme }}>
            <div className={`min-h-screen grid-pattern ${isDark ? 'dark' : 'light'} flex flex-col`}>
              <Sidebar
                currentPage={currentPage}
                setCurrentPage={setCurrentPage}
                profiles={profiles}
                onConnectAccount={() => setShowAuthModal(true)}
              />

              <div className="ml-64 flex-1 flex flex-col">
                <div className="p-6 flex-1">
                  <Header />
                  <main>
                    {currentPage === 'library' && (
                      <ContentLibraryPage
                        onPublish={handlePublish}
                      />
                    )}
                    {currentPage === 'settings' && (
                      <SettingsPage
                        profiles={profiles}
                        onConnectAccount={() => setShowAuthModal(true)}
                        onLogout={handleLogout}
                      />
                    )}
                  </main>
                </div>
                <Footer />
              </div>

              <AuthModal
                isOpen={showAuthModal}
                onClose={() => setShowAuthModal(false)}
                onSuccess={handleAuthSuccess}
              />

              {selectedVideo && (
                <TikTokPublishFlow
                  isOpen={!!selectedVideo}
                  onClose={() => setSelectedVideo(null)}
                  video={selectedVideo}
                  profile={profiles.tiktok}
                />
              )}
            </div>
          </ThemeContext.Provider>
        </TranslationContext.Provider>
      );
    }

    // ====== OAUTH CALLBACK HANDLER ======
    const urlParams = new URLSearchParams(window.location.search);
    const oauthCode = urlParams.get('code');
    const oauthState = urlParams.get('state');
    const oauthError = urlParams.get('error');

    if (oauthCode || oauthError) {
      const oauthData = {
        code: oauthCode,
        state: oauthState,
        error: oauthError,
        timestamp: Date.now()
      };
      sessionStorage.setItem('oauth_callback', JSON.stringify(oauthData));
      window.history.replaceState({}, document.title, window.location.pathname);

      if (window.opener) {
        try {
          window.opener.postMessage({
            type: 'oauth_code',
            code: oauthCode,
            state: oauthState,
            error: oauthError
          }, '*');
        } catch (e) {
          console.error('[Callback] postMessage failed:', e);
        }

        document.body.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; background: #0a0a0b; color: white;">
            <div style="text-align: center;">
              <h2 style="color: #10b981; margin-bottom: 1rem;">✓ Authorization successful!</h2>
              <p style="color: #94a3b8;">You can close this window</p>
            </div>
          </div>
        `;

        setTimeout(() => {
          window.close();
        }, 1500);
      } else {
        window.location.reload();
      }
    } else {
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    }
  </script>
</body>
</html>
